<!-- Generate posting dates data -->
{%- assign posting_dates = "" | split: "" -%}
{%- for post in site.posts -%}
  {%- assign post_date = post.date | date: "%Y-%m-%d" -%}
  {%- assign posting_dates = posting_dates | push: post_date -%}
{%- endfor -%}

<!-- Cute Sticky Note - Posting Activity -->
<div class="sticky-note-widget activity-sticky">
  <div class="sticky-tape"></div>
  <div class="sticky-content">
    <div class="sticky-title">
      <span class="sticky-icon">üìù</span>
      <span>Activity</span>
    </div>
    <div class="heatmap-wrapper">
      <div class="heatmap-months" id="heatmap-months"></div>
      <div class="heatmap-grid" id="heatmap-grid"></div>
    </div>
    <div class="activity-legend">
      <span class="legend-label">Less</span>
      <div class="legend-boxes">
        <span class="legend-box level-0"></span>
        <span class="legend-box level-1"></span>
        <span class="legend-box level-2"></span>
        <span class="legend-box level-3"></span>
        <span class="legend-box level-4"></span>
      </div>
      <span class="legend-label">More</span>
    </div>
  </div>
  <div class="sticky-corner activity-corner"></div>
</div>

<style>
/* Activity Sticky Note */
.sticky-note-widget.activity-sticky .sticky-content {
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
}

.sticky-note-widget.activity-sticky .sticky-corner.activity-corner {
  border-color: transparent transparent #8bc48e transparent;
}

.sticky-note-widget.activity-sticky .sticky-title {
  color: #2e5a2f;
  border-bottom-color: rgba(46, 90, 47, 0.2);
}

/* Heatmap Wrapper */
.heatmap-wrapper {
  background: rgba(255, 255, 255, 0.4);
  border-radius: 8px;
  padding: 10px;
  border: 1px dashed rgba(46, 90, 47, 0.2);
  overflow: hidden;
}

.heatmap-months {
  display: flex;
  gap: 0;
  margin-bottom: 3px;
  font-size: 9px;
  color: #3e6e40;
  height: 12px;
}

.heatmap-month {
  font-size: 9px;
  font-weight: 500;
}

.heatmap-grid {
  display: grid;
  grid-template-rows: repeat(7, 8px);
  grid-auto-flow: column;
  gap: 2px;
}

.heatmap-cell {
  width: 8px;
  height: 8px;
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.heatmap-cell:hover {
  transform: scale(1.5);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  z-index: 10;
}

.heatmap-cell.level-0 { background-color: rgba(255, 255, 255, 0.6); }
.heatmap-cell.level-1 { background-color: #81c784; }
.heatmap-cell.level-2 { background-color: #4caf50; }
.heatmap-cell.level-3 { background-color: #388e3c; }
.heatmap-cell.level-4 { background-color: #1b5e20; }

/* Activity Legend */
.activity-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 6px;
  margin-top: 10px;
  font-size: 9px;
  color: #3e6e40;
}

.legend-boxes {
  display: flex;
  gap: 2px;
}

.legend-box {
  width: 10px;
  height: 10px;
  border-radius: 2px;
}

.legend-box.level-0 { background-color: rgba(255, 255, 255, 0.6); }
.legend-box.level-1 { background-color: #81c784; }
.legend-box.level-2 { background-color: #4caf50; }
.legend-box.level-3 { background-color: #388e3c; }
.legend-box.level-4 { background-color: #1b5e20; }

/* Dark Theme */
html[data-theme="dark"] .sticky-note-widget.activity-sticky .sticky-content {
  background: linear-gradient(135deg, #2d4a2e 0%, #1e3a1f 100%);
}

html[data-theme="dark"] .sticky-note-widget.activity-sticky .sticky-corner.activity-corner {
  border-color: transparent transparent #152515 transparent;
}

html[data-theme="dark"] .sticky-note-widget.activity-sticky .sticky-title {
  color: #a5d6a7;
  border-bottom-color: rgba(165, 214, 167, 0.2);
}

html[data-theme="dark"] .heatmap-wrapper {
  background: rgba(0, 0, 0, 0.2);
  border-color: rgba(165, 214, 167, 0.2);
}

html[data-theme="dark"] .heatmap-months,
html[data-theme="dark"] .activity-legend {
  color: #81c784;
}

html[data-theme="dark"] .heatmap-cell.level-0,
html[data-theme="dark"] .legend-box.level-0 {
  background-color: rgba(0, 0, 0, 0.3);
}

html[data-theme="dark"] .heatmap-cell.level-1,
html[data-theme="dark"] .legend-box.level-1 { background-color: #0e4429; }

html[data-theme="dark"] .heatmap-cell.level-2,
html[data-theme="dark"] .legend-box.level-2 { background-color: #006d32; }

html[data-theme="dark"] .heatmap-cell.level-3,
html[data-theme="dark"] .legend-box.level-3 { background-color: #26a641; }

html[data-theme="dark"] .heatmap-cell.level-4,
html[data-theme="dark"] .legend-box.level-4 { background-color: #39d353; }

/* Mobile */
@media (max-width: 768px) {
  .heatmap-cell {
    width: 6px;
    height: 6px;
  }

  .heatmap-grid {
    grid-template-rows: repeat(7, 6px);
  }

  .heatmap-months {
    font-size: 8px;
  }
}
</style>

<script>
(function() {
  const postingDates = [
    {%- for date in posting_dates -%}
      "{{ date }}"{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];

  const postCountByDate = {};
  postingDates.forEach(date => {
    postCountByDate[date] = (postCountByDate[date] || 0) + 1;
  });

  function generateHeatmap() {
    const grid = document.getElementById('heatmap-grid');
    const monthsContainer = document.getElementById('heatmap-months');

    if (!grid || !monthsContainer) return;

    const today = new Date();
    const startPeriod = new Date(today);
    startPeriod.setDate(today.getDate() - 179);

    const startDate = new Date(startPeriod);
    startDate.setDate(startDate.getDate() - startDate.getDay());

    const maxPosts = Math.max(...Object.values(postCountByDate), 1);

    let currentMonth = -1;
    let monthSpans = [];
    const cells = [];
    let currentDate = new Date(startDate);
    let weekIndex = 0;

    while (currentDate <= today) {
      const dateStr = currentDate.toISOString().split('T')[0];
      const postCount = postCountByDate[dateStr] || 0;

      let level = 0;
      if (postCount > 0) {
        level = Math.min(4, Math.ceil((postCount / maxPosts) * 4));
      }

      const cell = document.createElement('div');
      cell.className = `heatmap-cell level-${level}`;
      cell.title = `${dateStr}: ${postCount} post${postCount !== 1 ? 's' : ''}`;
      cell.style.gridRow = currentDate.getDay() + 1;

      cells.push(cell);

      if (currentDate.getDay() === 0 || currentDate.getTime() === startDate.getTime()) {
        const monthNum = currentDate.getMonth();
        if (currentMonth !== monthNum) {
          const monthName = currentDate.toLocaleDateString('en-US', { month: 'short' });
          monthSpans.push({ name: monthName, week: weekIndex });
          currentMonth = monthNum;
        }
      }

      currentDate.setDate(currentDate.getDate() + 1);

      if (currentDate.getDay() === 0) {
        weekIndex++;
      }
    }

    const totalWeeks = weekIndex;

    cells.forEach(cell => grid.appendChild(cell));

    monthsContainer.style.display = 'grid';
    monthsContainer.style.gridTemplateColumns = `repeat(${totalWeeks}, 10px)`;
    monthsContainer.style.gap = '2px';

    monthSpans.forEach(({ name, week }, index) => {
      const monthLabel = document.createElement('span');
      monthLabel.className = 'heatmap-month';
      monthLabel.textContent = name;

      const nextWeek = index < monthSpans.length - 1 ? monthSpans[index + 1].week : totalWeeks;
      const spanWeeks = nextWeek - week;

      monthLabel.style.gridColumn = `${week + 1} / span ${spanWeeks}`;
      monthsContainer.appendChild(monthLabel);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateHeatmap);
  } else {
    generateHeatmap();
  }
})();
</script>
