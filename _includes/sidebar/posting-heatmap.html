<!-- Generate posting dates data -->
{%- assign posting_dates = "" | split: "" -%}
{%- for post in site.posts -%}
  {%- assign post_date = post.date | date: "%Y-%m-%d" -%}
  {%- assign posting_dates = posting_dates | push: post_date -%}
{%- endfor -%}

<div class="posting-heatmap-widget">
  <div class="widget-header">
    <h3>포스팅 활동</h3>
  </div>
  <div class="widget-content">
    <div class="heatmap-container">
      <div class="heatmap-months" id="heatmap-months"></div>
      <div class="heatmap-grid" id="heatmap-grid"></div>
      <div class="heatmap-legend">
        <span class="legend-label">Less</span>
        <span class="legend-box level-0"></span>
        <span class="legend-box level-1"></span>
        <span class="legend-box level-2"></span>
        <span class="legend-box level-3"></span>
        <span class="legend-box level-4"></span>
        <span class="legend-label">More</span>
      </div>
    </div>
  </div>
</div>

<style>
.posting-heatmap-widget {
  background: #f5f5f5;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  border: 1px solid #e0e0e0;
}

.posting-heatmap-widget .widget-header {
  margin-bottom: 12px;
}

.posting-heatmap-widget .widget-header h3 {
  font-size: 0.95rem;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.posting-heatmap-widget .widget-content {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #e0e0e0;
}

.heatmap-container {
  overflow-x: auto;
  overflow-y: hidden;
}

.heatmap-months {
  display: flex;
  gap: 0;
  margin-bottom: 4px;
  margin-left: 20px;
  font-size: 0.7rem;
  color: #666;
  height: 14px;
}

.heatmap-month {
  min-width: 26px;
  text-align: left;
}

.heatmap-grid {
  display: grid;
  grid-template-rows: repeat(7, 10px);
  grid-auto-flow: column;
  gap: 3px;
  margin-left: 20px;
}

.heatmap-day-label {
  font-size: 0.65rem;
  color: #666;
  text-align: right;
  padding-right: 4px;
  line-height: 10px;
  grid-column: 1;
}

.heatmap-cell {
  width: 10px;
  height: 10px;
  background-color: #ebedf0;
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.heatmap-cell:hover {
  transform: scale(1.3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.heatmap-cell.level-0 {
  background-color: #ebedf0;
}

.heatmap-cell.level-1 {
  background-color: #9be9a8;
}

.heatmap-cell.level-2 {
  background-color: #40c463;
}

.heatmap-cell.level-3 {
  background-color: #30a14e;
}

.heatmap-cell.level-4 {
  background-color: #216e39;
}

.heatmap-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 3px;
  margin-top: 8px;
  font-size: 0.7rem;
  color: #666;
}

.legend-box {
  width: 10px;
  height: 10px;
  border-radius: 2px;
}

.legend-label {
  font-size: 0.65rem;
  margin: 0 2px;
}

/* Dark Theme */
html[data-theme="dark"] .posting-heatmap-widget {
  background: #2a2a2a;
  border-color: #444;
}

html[data-theme="dark"] .posting-heatmap-widget .widget-header h3 {
  color: #e0e0e0;
}

html[data-theme="dark"] .posting-heatmap-widget .widget-content {
  background: #1e1e1e;
  border-color: #444;
}

html[data-theme="dark"] .heatmap-months,
html[data-theme="dark"] .heatmap-legend,
html[data-theme="dark"] .legend-label {
  color: #aaa;
}

html[data-theme="dark"] .heatmap-cell.level-0 {
  background-color: #161b22;
}

html[data-theme="dark"] .heatmap-cell.level-1 {
  background-color: #0e4429;
}

html[data-theme="dark"] .heatmap-cell.level-2 {
  background-color: #006d32;
}

html[data-theme="dark"] .heatmap-cell.level-3 {
  background-color: #26a641;
}

html[data-theme="dark"] .heatmap-cell.level-4 {
  background-color: #39d353;
}
</style>

<script>
(function() {
  // Jekyll에서 생성한 포스팅 날짜 데이터
  const postingDates = [
    {%- for date in posting_dates -%}
      "{{ date }}"{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];

  // 날짜별 포스팅 수 계산
  const postCountByDate = {};
  postingDates.forEach(date => {
    postCountByDate[date] = (postCountByDate[date] || 0) + 1;
  });

  function generateHeatmap() {
    const grid = document.getElementById('heatmap-grid');
    const monthsContainer = document.getElementById('heatmap-months');

    if (!grid || !monthsContainer) return;

    // 최근 365일 계산
    const today = new Date();
    const oneYearAgo = new Date(today);
    oneYearAgo.setDate(today.getDate() - 364);

    // 시작일을 일요일로 맞추기
    const startDate = new Date(oneYearAgo);
    startDate.setDate(startDate.getDate() - startDate.getDay());

    // 최대 포스팅 수 찾기
    const maxPosts = Math.max(...Object.values(postCountByDate), 1);

    // 월 헤더 생성
    const months = [];
    let currentMonth = '';
    let weekCount = 0;
    let monthSpans = [];

    // 히트맵 셀 생성
    const cells = [];
    let currentDate = new Date(startDate);
    let weekIndex = 0;

    while (currentDate <= today) {
      const dateStr = currentDate.toISOString().split('T')[0];
      const postCount = postCountByDate[dateStr] || 0;

      // 레벨 계산 (0-4)
      let level = 0;
      if (postCount > 0) {
        level = Math.min(4, Math.ceil((postCount / maxPosts) * 4));
      }

      const cell = document.createElement('div');
      cell.className = `heatmap-cell level-${level}`;
      cell.title = `${dateStr}: ${postCount} post${postCount !== 1 ? 's' : ''}`;
      cell.style.gridRow = currentDate.getDay() + 1;

      cells.push(cell);

      // 월 헤더 추적
      const monthName = currentDate.toLocaleDateString('ko-KR', { month: 'short' });
      if (currentDate.getDate() === 1 || (currentDate.getDay() === 0 && currentMonth !== monthName)) {
        if (currentMonth !== monthName) {
          monthSpans.push({ name: monthName, week: weekIndex });
          currentMonth = monthName;
        }
      }

      // 다음 날로 이동
      currentDate.setDate(currentDate.getDate() + 1);

      // 일요일이면 다음 주로
      if (currentDate.getDay() === 0) {
        weekIndex++;
      }
    }

    // 셀 추가
    cells.forEach(cell => grid.appendChild(cell));

    // 월 헤더 추가
    monthSpans.forEach(({ name, week }) => {
      const monthLabel = document.createElement('span');
      monthLabel.className = 'heatmap-month';
      monthLabel.textContent = name;
      monthLabel.style.gridColumn = `${week + 1} / span 4`;
      monthsContainer.appendChild(monthLabel);
    });
  }

  // DOM 로드 후 실행
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateHeatmap);
  } else {
    generateHeatmap();
  }
})();
</script>
