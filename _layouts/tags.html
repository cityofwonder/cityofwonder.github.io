---
layout: framework
sidebar: tag-list
---

{%- if site.posts.size > 0 -%}

  {%- include functions.html func='log' level='debug' msg='Get tags value' -%}
  {%- include functions.html func='get_tags' -%}
  {% assign tags = return %}

  <!-- Tag Graph Visualization -->
  <div class="page-card">
    <div class="page-card-header">
      <div class="card-buttons">
        <span class="card-btn btn-close"></span>
        <span class="card-btn btn-minimize"></span>
        <span class="card-btn btn-maximize"></span>
      </div>
      <div class="card-title">Tag Relations</div>
    </div>
    <div class="graph-content">
      <svg id="tag-graph"></svg>
      <div id="tag-tooltip" class="tag-tooltip"></div>
    </div>
  </div>

  <!-- Post-Tag Data for JavaScript -->
  <script id="post-tags-data" type="application/json">
  [
    {% for post in site.posts %}
      {
        "title": {{ post.title | jsonify }},
        "url": "{{ post.url | relative_url }}",
        "date": "{{ post.date | date: '%Y-%m-%d' }}",
        "tags": {{ post.tags | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  </script>

  <!-- Tags Post List -->
  <div class="page-card">
    <div class="page-card-header">
      <div class="card-buttons">
        <span class="card-btn btn-close"></span>
        <span class="card-btn btn-minimize"></span>
        <span class="card-btn btn-maximize"></span>
      </div>
      <div class="card-title">All Posts</div>
      <div class="card-count">{{ site.posts.size }}</div>
    </div>

    <!-- Tag Filter Pills -->
    <div class="filter-bar">
      <button class="filter-pill active" data-tag="all">
        <span class="pill-label">All</span>
      </button>
      {% for tag in tags %}
        {% assign tag_posts = site.posts | where: 'tags', tag %}
        <button class="filter-pill" data-tag="{{ tag }}">
          <span class="pill-label">{{ tag }}</span>
          <span class="pill-count">{{ tag_posts.size }}</span>
        </button>
      {% endfor %}
    </div>

    <!-- Posts Grid -->
    <div class="card-content">
      <div class="posts-grid">
        {% for post in site.posts %}
        <div class="post-item" data-tags="{{ post.tags | join: ',' }}">
          <a href="{{ post.url | relative_url }}" class="post-link">
            <span class="post-date">{{ post.date | date: "%m/%d" }}</span>
            <span class="post-title">{{ post.title | escape }}</span>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

{%- endif -%}

<style>
  /* ===== Unified Page Card Style ===== */
  .page-card {
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
    margin-bottom: 24px;
    overflow: hidden;
  }

  .page-card-header {
    background: linear-gradient(180deg, #fafafa 0%, #f0f0f0 100%);
    padding: 8px 14px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #e5e5e5;
  }

  .card-buttons {
    display: flex;
    gap: 6px;
  }

  .card-btn {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }

  .btn-close { background: #ff5f57; }
  .btn-minimize { background: #febc2e; }
  .btn-maximize { background: #28c840; }

  .card-title {
    flex: 1;
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    color: #666;
  }

  .card-count {
    font-size: 11px;
    color: #999;
    background: #eee;
    padding: 2px 8px;
    border-radius: 10px;
  }

  /* ===== Graph Content ===== */
  .graph-content {
    position: relative;
    background: #fafafa;
  }

  #tag-graph {
    width: 100%;
    height: 350px;
    display: block;
  }

  .graph-link {
    stroke: #999;
    stroke-opacity: 0.3;
    fill: none;
    transition: stroke-opacity 0.2s ease;
  }

  .graph-link.highlighted {
    stroke: #555;
    stroke-opacity: 0.7;
  }

  .graph-link.dimmed {
    stroke-opacity: 0.1;
  }

  .graph-node {
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .graph-node circle {
    fill: #888;
    stroke: #fff;
    stroke-width: 2px;
    transition: all 0.2s ease;
  }

  .graph-node:hover circle {
    fill: #555;
  }

  .graph-node.dimmed circle {
    fill: #ccc;
    opacity: 0.5;
  }

  .graph-node.highlighted circle {
    fill: #333;
  }

  .node-label {
    font-size: 10px;
    font-weight: 500;
    fill: #555;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    text-anchor: middle;
  }

  .graph-node:hover .node-label,
  .graph-node.highlighted .node-label {
    opacity: 1;
  }

  .tag-tooltip {
    position: absolute;
    padding: 8px 12px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s ease;
    z-index: 100;
    border: 1px solid #e5e5e5;
  }

  .tag-tooltip.visible {
    opacity: 1;
  }

  .tag-tooltip .tag-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
  }

  .tag-tooltip .tag-count {
    color: #888;
    font-size: 11px;
  }

  /* ===== Filter Bar ===== */
  .filter-bar {
    padding: 12px 14px;
    background: #fafafa;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .filter-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 14px;
    font-size: 11px;
    color: #666;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .filter-pill:hover {
    border-color: #999;
    color: #333;
  }

  .filter-pill.active {
    background: #555;
    border-color: #555;
    color: #fff;
  }

  .filter-pill .pill-count {
    font-size: 10px;
    opacity: 0.7;
  }

  .filter-pill.active .pill-count {
    opacity: 0.8;
  }

  /* ===== Card Content ===== */
  .card-content {
    padding: 14px;
    background: #fff;
    max-height: 500px;
    overflow-y: auto;
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .post-item {
    transition: all 0.15s ease;
  }

  .post-item.hidden {
    display: none;
  }

  .post-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: #fafafa;
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .post-link:hover {
    background: #f0f0f0;
    transform: translateX(3px);
  }

  .post-date {
    font-size: 11px;
    font-weight: 500;
    color: #888;
    flex-shrink: 0;
  }

  .post-title {
    font-size: 12px;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .post-link:hover .post-title {
    color: #111;
  }

  /* ===== Scrollbar ===== */
  .card-content::-webkit-scrollbar,
  .filter-bar::-webkit-scrollbar {
    width: 4px;
    height: 4px;
  }

  .card-content::-webkit-scrollbar-track,
  .filter-bar::-webkit-scrollbar-track {
    background: transparent;
  }

  .card-content::-webkit-scrollbar-thumb,
  .filter-bar::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 2px;
  }

  /* ===== Dark Theme ===== */
  html[data-theme="dark"] .page-card {
    background: #1e1e1e;
    border-color: #333;
  }

  html[data-theme="dark"] .page-card-header {
    background: linear-gradient(180deg, #2a2a2a 0%, #222 100%);
    border-bottom-color: #333;
  }

  html[data-theme="dark"] .card-title {
    color: #aaa;
  }

  html[data-theme="dark"] .card-count {
    background: #333;
    color: #888;
  }

  html[data-theme="dark"] .graph-content {
    background: #1a1a1a;
  }

  html[data-theme="dark"] .graph-link {
    stroke: #666;
  }

  html[data-theme="dark"] .graph-link.highlighted {
    stroke: #999;
  }

  html[data-theme="dark"] .graph-node circle {
    fill: #777;
    stroke: #1e1e1e;
  }

  html[data-theme="dark"] .graph-node:hover circle {
    fill: #aaa;
  }

  html[data-theme="dark"] .graph-node.highlighted circle {
    fill: #ccc;
  }

  html[data-theme="dark"] .node-label {
    fill: #ccc;
  }

  html[data-theme="dark"] .tag-tooltip {
    background: #2a2a2a;
    border-color: #444;
  }

  html[data-theme="dark"] .tag-tooltip .tag-name {
    color: #ddd;
  }

  html[data-theme="dark"] .tag-tooltip .tag-count {
    color: #888;
  }

  html[data-theme="dark"] .filter-bar {
    background: #1a1a1a;
    border-bottom-color: #333;
  }

  html[data-theme="dark"] .filter-pill {
    background: #2a2a2a;
    border-color: #444;
    color: #aaa;
  }

  html[data-theme="dark"] .filter-pill:hover {
    border-color: #666;
    color: #ddd;
  }

  html[data-theme="dark"] .filter-pill.active {
    background: #555;
    border-color: #555;
    color: #fff;
  }

  html[data-theme="dark"] .card-content {
    background: #1e1e1e;
  }

  html[data-theme="dark"] .post-link {
    background: #252525;
  }

  html[data-theme="dark"] .post-link:hover {
    background: #2a2a2a;
  }

  html[data-theme="dark"] .post-date {
    color: #777;
  }

  html[data-theme="dark"] .post-title {
    color: #ccc;
  }

  html[data-theme="dark"] .post-link:hover .post-title {
    color: #fff;
  }

  html[data-theme="dark"] .card-content::-webkit-scrollbar-thumb {
    background: #444;
  }

  /* ===== Mobile ===== */
  @media (max-width: 768px) {
    .page-card {
      margin-bottom: 16px;
    }

    #tag-graph {
      height: 280px;
    }

    .filter-bar {
      padding: 10px 12px;
    }

    .card-content {
      padding: 10px;
      max-height: 400px;
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .post-link {
      padding: 6px 8px;
    }

    .post-title {
      font-size: 11px;
    }
  }
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ===== Tag Filter =====
    const filterPills = document.querySelectorAll('.filter-pill');
    const postItems = document.querySelectorAll('.post-item');

    function filterByTag(selectedTag) {
      filterPills.forEach(pill => {
        pill.classList.toggle('active', pill.dataset.tag === selectedTag);
      });

      postItems.forEach(item => {
        const itemTags = item.dataset.tags.split(',');
        if (selectedTag === 'all' || itemTags.includes(selectedTag)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    }

    filterPills.forEach(pill => {
      pill.addEventListener('click', () => filterByTag(pill.dataset.tag));
    });

    // ===== Tag Graph =====
    const svg = d3.select('#tag-graph');
    const tooltip = document.getElementById('tag-tooltip');
    const container = document.querySelector('.graph-content');

    if (!svg.node() || !container) return;

    const postTagsData = JSON.parse(document.getElementById('post-tags-data').textContent);

    const tagCounts = {};
    const edgeCounts = {};

    postTagsData.forEach(post => {
      const tags = post.tags || [];
      tags.forEach(tag => {
        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
      });
      for (let i = 0; i < tags.length; i++) {
        for (let j = i + 1; j < tags.length; j++) {
          const key = [tags[i], tags[j]].sort().join('|||');
          edgeCounts[key] = (edgeCounts[key] || 0) + 1;
        }
      }
    });

    const nodes = Object.entries(tagCounts).map(([tag, count]) => ({
      id: tag,
      count: count,
      radius: Math.max(5, Math.min(16, 3 + count * 2.5))
    }));

    const links = Object.entries(edgeCounts).map(([key, count]) => {
      const [source, target] = key.split('|||');
      return { source, target, weight: count };
    });

    const width = container.offsetWidth;
    const height = parseInt(getComputedStyle(svg.node()).height);

    svg.attr('viewBox', [0, 0, width, height]);

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id).distance(70).strength(0.4))
      .force('charge', d3.forceManyBody().strength(-100))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(d => d.radius + 6).strength(0.8));

    const link = svg.append('g').selectAll('line')
      .data(links).join('line').attr('class', 'graph-link')
      .attr('stroke-width', d => Math.max(1, d.weight * 1.5));

    const node = svg.append('g').selectAll('g')
      .data(nodes).join('g').attr('class', 'graph-node')
      .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

    node.append('circle').attr('r', d => d.radius);
    node.append('text').attr('class', 'node-label').attr('dy', d => -d.radius - 4).text(d => d.id);

    node.on('mouseenter', function(event, d) {
      tooltip.innerHTML = `<div class="tag-name">${d.id}</div><div class="tag-count">${d.count} posts</div>`;
      tooltip.classList.add('visible');
      const rect = container.getBoundingClientRect();
      tooltip.style.left = `${event.clientX - rect.left + 10}px`;
      tooltip.style.top = `${event.clientY - rect.top - 10}px`;

      const connected = new Set([d.id]);
      link.each(function(l) {
        if (l.source.id === d.id || l.target.id === d.id) {
          connected.add(l.source.id);
          connected.add(l.target.id);
          d3.select(this).classed('highlighted', true).classed('dimmed', false);
        } else {
          d3.select(this).classed('dimmed', true).classed('highlighted', false);
        }
      });
      node.each(function(n) {
        d3.select(this).classed(connected.has(n.id) ? 'highlighted' : 'dimmed', true);
        if (connected.has(n.id)) d3.select(this).classed('dimmed', false);
      });
    })
    .on('mouseleave', function() {
      tooltip.classList.remove('visible');
      link.classed('highlighted', false).classed('dimmed', false);
      node.classed('highlighted', false).classed('dimmed', false);
    })
    .on('click', function(event, d) {
      event.preventDefault();
      filterByTag(d.id);
    });

    simulation.on('tick', () => {
      nodes.forEach(d => {
        d.x = Math.max(d.radius + 5, Math.min(width - d.radius - 5, d.x));
        d.y = Math.max(d.radius + 5, Math.min(height - d.radius - 5, d.y));
      });
      link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
      node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }
  });
</script>
